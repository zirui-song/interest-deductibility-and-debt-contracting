--------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/zrsong/MIT Dropbox/Zirui Song/Research Projects/MPS_Interest Deduc
> tibility and Debt Contracting/4. Code/Dealscan_Analysis.log
  log type:  text
 opened on:  24 Feb 2025, 17:58:24

. 
. use "../3. Data/Processed/tranche_level_ds_compa.dta", clear

. 
. if "`c(hostname)'" == "mphill-surface4" {
. global overleaf_dir "C:\Users\mphill\Dropbox\Apps\Overleaf\Tax Incidence and Loan Co
> ntract Negotiations\Tables"
. global fig_dir "C:\Users\mphill\Dropbox\Apps\Overleaf\Tax Incidence and Loan Contrac
> t Negotiations\Figures"
.         
. }

. 
. global overleaf_dir "/Users/zrsong/MIT Dropbox/Zirui Song/Apps/Overleaf/Tax Incidenc
> e and Loan Contract Negotiations/Tables"

. global fig_dir "/Users/zrsong/MIT Dropbox/Zirui Song/Apps/Overleaf/Tax Incidence and
>  Loan Contract Negotiations/Figures"

. 
. keep if year >= 2014
(0 observations deleted)

. drop if year == 2020 | year == 2021
(895 observations deleted)

. 
. * Check if the directory exists, if not create it
. cap mkdir "$overleaf_dir"

. 
. * gen logged bps
. gen log_margin_bps = log(margin_bps)

. gen log_at = log(at)

. gen log_deal_amount_converted = log(deal_amount_converted)

. 
. *** treatment
. /*replace treated = 0 if treated_loss == 1
> replace treated_prev_3yr = 0 if treated_loss_prev_3yr == 1
> replace treated_prev_5yr = 0 if treated_loss_prev_5yr == 1
> replace treated_next_1yr = 0 if treated_loss_next_1yr == 1
> replace treated_next_3yr = 0 if treated_loss_next_3yr == 1
> replace treated_next_5yr = 0 if treated_loss_next_5yr == 1 */
. 
. local controls "log_at market_to_book ppent_by_at debt_by_at cash_by_at dividend_pay
> er ret_vol"

. local deal_controls "leveraged maturity log_deal_amount_converted secured_dummy tran
> che_type_dummy tranche_o_a_dummy sponsor_dummy"

. 
. * generate interaction between controls and post
. foreach var in `controls' {
  2.     gen `var'_post = `var' * post
  3.         gen `var'_treated = `var' * treated
  4.         gen `var'_treated_loss = `var' * treated_loss
  5. }

. foreach var in `deal_controls' {
  2.         gen `var'_post = `var' * post
  3. }

. 
. local controls_post "log_at_post market_to_book_post ppent_by_at_post debt_by_at_pos
> t cash_by_at_post  dividend_payer_post ret_vol_post"

. local deal_controls_post "leveraged_post maturity_post log_deal_amount_converted_pos
> t secured_dummy_post tranche_type_dummy_post tranche_o_a_dummy_post sponsor_dummy_po
> st"

. 
. local controls_treated "log_at_treated market_to_book_treated ppent_by_at_treated de
> bt_by_at_treated cash_by_at_treated dividend_payer_treated ret_vol_treated"

. local controls_treated_loss "log_at_treated_loss market_to_book_treated_loss ppent_b
> y_at_treated_loss debt_by_at_treated_loss cash_by_at_treated_loss dividend_payer_tre
> ated_loss ret_vol_treated_loss"

. 
. * winsorize at 1% and 99%
. foreach var in margin_bps log_margin_bps `controls' `deal_controls' `controls_post' 
> `controls_treated' `controls_treated_loss' {
  2.     winsor2 `var', cuts(1 99) replace
  3. }

. 
. * label controls and treated, post, and treated_post
. label variable log_at "Log Total Assets"

. label variable cash_flows_by_at "Cash Flows / Assets"

. label variable market_to_book "Market to Book Ratio"

. label variable ppent_by_at "PP\&E / Assets"

. label variable debt_by_at "Debt / Assets"

. label variable cash_by_at "Cash / Assets"

. label variable sales_growth "Sales Growth"

. label variable dividend_payer "Dividend Payer"

. label variable z_score "Z-Score"

. label variable nol "Net Operating Loss"

. label variable ret_buy_and_hold "Buy and Hold Return"

. label variable ret_vol "Return Volatility"

. 
. label variable leveraged "Leveraged"

. label variable maturity "Maturity"

. label variable log_deal_amount_converted "Log Loan Amount"

. label variable secured_dummy "Secured"

. label variable tranche_type_dummy "Tranche Type"

. label variable tranche_o_a_dummy "Origination"

. label variable sponsor_dummy "Sponsored"

. 
. label variable treated "Excess Interest (30\% Rule)"

. label variable post "Post"

. label variable treated_post "Excess Interest (30\% Rule) x Post"

. label variable treated_loss "Excess Interest (Loss)"

. label variable treated_loss_post "Excess Interest (Loss) x Post"

. 
. label variable treated_prev_3yr "Excess Interest (30\% Rule, Previous 3 Years)"

. label variable treated_prev_3yr_post "Excess Interest (30\% Rule, Previous 3 Years) 
> x Post"

. label variable treated_loss_prev_3yr "Excess Interest (Loss, Previous 3 Years)"

. label variable treated_loss_prev_3yr_post "Excess Interest (Loss, Previous 3 Years) 
> x Post"

. label variable treated_prev_5yr "Excess Interest (30\% Rule, Previous 5 Years)"

. label variable treated_prev_5yr_post "Excess Interest (30\% Rule, Previous 5 Years) 
> x Post"

. label variable treated_loss_prev_5yr "Excess Interest (Loss, Previous 5 Years)"

. label variable treated_loss_prev_5yr_post "Excess Interest (Loss, Previous 5 Years) 
> x Post"

. 
. save "../3. Data/Processed/tranche_level_ds_compa_wlabel.dta", replace
file ../3. Data/Processed/tranche_level_ds_compa_wlabel.dta saved

. 
. /***********
>         Bring in SP Ratings
>         ***********/
.         
.         use "../3. Data/Processed/tranche_level_ds_compa_wlabel.dta", clear

. 
. capture program drop clean_rating

. program define clean_rating
  1.         rename currentratingsymbol sp_rating
  2.         replace sp_rating = subinstr(sp_rating, " prelim", "", .) 
  3. 
.         gen sp_rating_num = .
  4.         replace sp_rating_num = 21 if sp_rating == "AAA"
  5.         * replace sp_rating_num = 21 if sp_rating == "AA+" (only 1 obs)
.         replace sp_rating_num = 20 if sp_rating == "AA" | sp_rating == "ilAA" | sp_r
> ating == "AA+"
  6.         replace sp_rating_num = 19 if sp_rating == "AA-"
  7.         replace sp_rating_num = 18 if sp_rating == "A+"
  8.         replace sp_rating_num = 17 if sp_rating == "A"
  9.         replace sp_rating_num = 16 if sp_rating == "A-" | sp_rating == "A-1+" | s
> p_rating == "A-2" | sp_rating == "A-3"
 10.         replace sp_rating_num = 15 if sp_rating == "BBB+"
 11.         replace sp_rating_num = 14 if sp_rating == "BBB"
 12.         replace sp_rating_num = 13 if sp_rating == "BBB-"
 13.         replace sp_rating_num = 12 if sp_rating == "BB+"
 14.         replace sp_rating_num = 11 if sp_rating == "BB"
 15.         replace sp_rating_num = 10 if sp_rating == "BB-"
 16.         replace sp_rating_num = 9  if sp_rating == "B+"
 17.         replace sp_rating_num = 8  if sp_rating == "B"
 18.         replace sp_rating_num = 7  if sp_rating == "B-"
 19.         replace sp_rating_num = 6  if sp_rating == "CCC+"
 20.         replace sp_rating_num = 5  if sp_rating == "CCC"
 21.         replace sp_rating_num = 4  if sp_rating == "CCC-"
 22.         replace sp_rating_num = 3  if sp_rating == "CC"
 23.         replace sp_rating_num = 2  if sp_rating == "C"
 24.         replace sp_rating_num = 1  if sp_rating == "D"
 25.         replace sp_rating_num = 0 if sp_rating_num == .
 26. end

. 
. clean_rating
(14 real changes made)
(4,079 missing values generated)
(0 real changes made)
(2 real changes made)
(10 real changes made)
(21 real changes made)
(31 real changes made)
(301 real changes made)
(160 real changes made)
(234 real changes made)
(189 real changes made)
(185 real changes made)
(330 real changes made)
(253 real changes made)
(214 real changes made)
(294 real changes made)
(88 real changes made)
(21 real changes made)
(5 real changes made)
(5 real changes made)
(0 real changes made)
(0 real changes made)
(9 real changes made)
(1,727 real changes made)

. 
. local treat_vars "treated treated_post treated_loss treated_loss_post"  

. 
. gen not_rated = 1 if sp_rating_num == 0
(2,352 missing values generated)

. replace not_rated = 0 if not_rated == .
(2,352 real changes made)

. 
. label var sp_rating_num "S\&P Rating"

. label var not_rated "Not Rated"

. 
. * LHS Sample Composition Tests
. reghdfe not_rated `treat_vars' `controls' `deal_controls', absorb(year ff_48) vce(cl
> uster gvkey)
(MWFE estimator converged in 5 iterations)

HDFE Linear regression                            Number of obs   =      4,079
Absorbing 2 HDFE groups                           F(  18,   1443) =      22.98
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.2542
                                                  Adj R-squared   =     0.2406
                                                  Within R-sq.    =     0.1958
Number of clusters (gvkey)   =      1,444         Root MSE        =     0.4306

                                     (Std. err. adjusted for 1,444 clusters in gvkey)
-------------------------------------------------------------------------------------
                    |               Robust
          not_rated | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------------+----------------------------------------------------------------
            treated |     .01989   .0531712     0.37   0.708    -.0844111    .1241911
       treated_post |   .0454021   .0655156     0.69   0.488    -.0831138    .1739181
       treated_loss |     .03408   .0487498     0.70   0.485    -.0615481    .1297082
  treated_loss_post |   .1114279   .0622019     1.79   0.073     -.010588    .2334438
             log_at |  -.1013592   .0102924    -9.85   0.000    -.1215489   -.0811696
     market_to_book |   .0211217   .0132228     1.60   0.110    -.0048163    .0470597
        ppent_by_at |  -.0017551   .0682773    -0.03   0.979    -.1356885    .1321783
         debt_by_at |  -.2300096   .0724248    -3.18   0.002    -.3720787   -.0879405
         cash_by_at |  -.0266312   .1048329    -0.25   0.800    -.2322724    .1790101
     dividend_payer |   .0569117   .0299782     1.90   0.058    -.0018938    .1157172
            ret_vol |  -.2520761   .2817332    -0.89   0.371    -.8047264    .3005743
          leveraged |  -.0197426   .0297663    -0.66   0.507    -.0781324    .0386472
           maturity |  -.0161627    .006822    -2.37   0.018    -.0295448   -.0027805
log_deal_amount_c~d |  -.0410157   .0118538    -3.46   0.001    -.0642682   -.0177633
      secured_dummy |  -.0218018   .0269607    -0.81   0.419    -.0746882    .0310846
 tranche_type_dummy |  -.0377853   .0137982    -2.74   0.006    -.0648519   -.0107187
  tranche_o_a_dummy |  -.0061219   .0218838    -0.28   0.780    -.0490493    .0368055
      sponsor_dummy |    .007858   .0348824     0.23   0.822    -.0605676    .0762836
              _cons |    1.66388   .0942329    17.66   0.000     1.479032    1.848729
-------------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
       ff_48 |        49           1          48     |
-----------------------------------------------------+

. estimates store m2

. preserve 

.         drop if sp_rating_num == 0
(1,727 observations deleted)

.         reghdfe sp_rating_num `treat_vars' `controls' `deal_controls', absorb(year f
> f_48) vce(cluster gvkey)
(MWFE estimator converged in 6 iterations)

HDFE Linear regression                            Number of obs   =      2,352
Absorbing 2 HDFE groups                           F(  18,    767) =     125.92
Statistics robust to heteroskedasticity           Prob > F        =     0.0000
                                                  R-squared       =     0.7563
                                                  Adj R-squared   =     0.7486
                                                  Within R-sq.    =     0.7084
Number of clusters (gvkey)   =        768         Root MSE        =     1.5306

                                       (Std. err. adjusted for 768 clusters in gvkey)
-------------------------------------------------------------------------------------
                    |               Robust
      sp_rating_num | Coefficient  std. err.      t    P>|t|     [95% conf. interval]
--------------------+----------------------------------------------------------------
            treated |  -1.000009   .2570644    -3.89   0.000    -1.504642   -.4953755
       treated_post |   .1512553    .339355     0.45   0.656    -.5149196    .8174301
       treated_loss |  -.5996537   .2548474    -2.35   0.019    -1.099935   -.0993726
  treated_loss_post |   .4931184   .4115024     1.20   0.231    -.3146861    1.300923
             log_at |   .8956325   .0762376    11.75   0.000     .7459734    1.045291
     market_to_book |   .4410346   .0799098     5.52   0.000     .2841667    .5979026
        ppent_by_at |  -.7568534   .3517574    -2.15   0.032    -1.447375   -.0663319
         debt_by_at |  -1.713699   .3537208    -4.84   0.000    -2.408075   -1.019323
         cash_by_at |  -.7014968   .6937945    -1.01   0.312    -2.063458    .6604646
     dividend_payer |   .8484092   .1600694     5.30   0.000     .5341831    1.162635
            ret_vol |  -8.195402    1.68863    -4.85   0.000    -11.51029   -4.880516
          leveraged |  -1.502438   .1782288    -8.43   0.000    -1.852312   -1.152564
           maturity |   .0547115   .0392803     1.39   0.164    -.0223981    .1318211
log_deal_amount_c~d |  -.2797285   .0612109    -4.57   0.000    -.3998892   -.1595678
      secured_dummy |  -.6704885   .1250882    -5.36   0.000    -.9160444   -.4249327
 tranche_type_dummy |  -.0187078   .0607411    -0.31   0.758    -.1379464    .1005308
  tranche_o_a_dummy |    -.06826   .1027717    -0.66   0.507    -.2700071    .1334872
      sponsor_dummy |  -.1406264    .165034    -0.85   0.394    -.4645983    .1833456
              _cons |    7.50533   .7177304    10.46   0.000      6.09638    8.914279
-------------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
        year |         8           0           8     |
       ff_48 |        48           1          47     |
-----------------------------------------------------+

.         estimates store m1

. restore

. * save the results (esttab) using overleaf_dir
. esttab m1 m2 using "$overleaf_dir/sp_rating_robustness.tex", replace ///
> nodepvars nomti nonum collabels(none) label b(3) se(3) parentheses ///
> star(* 0.10 ** 0.05 *** 0.01) ar2 plain lines fragment noconstant keep(`treat_vars' 
> `controls' `deal_controls')
(output written to /Users/zrsong/MIT Dropbox/Zirui Song/Apps/Overleaf/Tax Incidence an
> d Loan Contract Negotiations/Tables/sp_rating_robustness.tex)

. est clear

. 
. save "../3. Data/Processed/tranche_level_ds_compa_wlabel.dta", replace
file ../3. Data/Processed/tranche_level_ds_compa_wlabel.dta saved

. 
end of do-file

. do "/var/folders/n2/pgdf58ms1yd3ch8xjn9fmpmm0000gq/T//SD12885.000000"

. log using Dealscan_Analysis.log, replace
log file already open
r(604);

end of do-file

r(604);

. log close
      name:  <unnamed>
       log:  /Users/zrsong/MIT Dropbox/Zirui Song/Research Projects/MPS_Interest Deduc
> tibility and Debt Contracting/4. Code/Dealscan_Analysis.log
  log type:  text
 closed on:  24 Feb 2025, 18:10:42
--------------------------------------------------------------------------------------
